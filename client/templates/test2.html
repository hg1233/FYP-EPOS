<html>
    <head>
        <link rel="stylesheet" href="../frontend/master-style.css" />
        <link rel="stylesheet" href="../frontend/sale.css" />
    </head>
    <body>    
        <div class="sale-container">
            <div class="products-container" id="products-container">
            </div>
            <div class="sidebar">
                <div class="ticket">
                    <!-- ticket/order header-->
                    <h2>Order # 203-1</h2> <!-- order_id + '-' + suborder_id -->
                    <h3>Table 12 ~ Covers 2</h3> <!-- table display_name & seats-->
                    <h3>Mr Smith</h3> <!-- order_name -->
                    <div class="spacer"></div>


                    <!-- order table -->
                    <table id="order-table">
                        <tr></tr>
                        <!-- <tr>
                            <td>1x</td>
                            <td>Carling</td>
                            <td>£2.50</td>
                        </tr> -->
                    </table>
                    <h2 id="order-total" data-total=0>Total: £0.00</h2>

                </div>
                <div class="functions">
                    <div class="btn" onclick="showSetQtyModal()">
                        <h3>Set Quantity</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-overlay">
            <div class="modal" id="set-qty-modal">
                <h1>Set Quantity</h1>
                <p>Enter the desired quantity for the next product for the order:</p>
                <input class="modal-input" type="number" id="qty-entry" placeholder="Enter Quantity" readonly>
                <div class="sale-keypad">
                    <div class="sale-keypad">
                        <div class="sale-keypad-row">
                          <button class="sale-keypad-key" onclick="addToQty('1')">1</button>
                          <button class="sale-keypad-key" onclick="addToQty('2')">2</button>
                          <button class="sale-keypad-key" onclick="addToQty('3')">3</button>
                        </div>
                        <div class="sale-keypad-row">
                          <button class="sale-keypad-key" onclick="addToQty('4')">4</button>
                          <button class="sale-keypad-key" onclick="addToQty('5')">5</button>
                          <button class="sale-keypad-key" onclick="addToQty('6')">6</button>
                        </div>
                        <div class="sale-keypad-row">
                          <button class="sale-keypad-key" onclick="addToQty('7')">7</button>
                          <button class="sale-keypad-key" onclick="addToQty('8')">8</button>
                          <button class="sale-keypad-key" onclick="addToQty('9')">9</button>
                        </div>
                        <div class="sale-keypad-row">
                          <button class="sale-keypad-key" onclick="clearQtyEntry()">Clear</button>
                          <button class="sale-keypad-key" onclick="addToQty('0')">0</button>
                          <button class="sale-keypad-key primary-btn" onclick="updateQty()">Confirm</button>
                          <!-- // TODO add cancel operation btn -->
                        </div>
                      </div>

                </div>
            </div>
        </div>

    </body>
    <script src="../frontend/products_link.js"></script>
    <script src="../frontend/categories_link.js"></script>
    <script src="../frontend/window_manager_link.js"></script>

    <script>

        qty_modifier_active = false;

        async function handleProductClick(product_id) {
            if(qty_modifier_active == true) {
                addProductToOrder(product_id, qty_modifier)
            } else {
                addProductToOrder(product_id, 1)
            }
        }

        async function generateCategoryAndProductsEntry(category, products) {
            // check if a category has products associated with it before generating
            if(category.products != null || category.products != undefined) {
                
                let cat_container = document.createElement('div');
                cat_container.classList.add('category');

                let cat_header = document.createElement('h2');
                cat_header.innerText = category.name;
                cat_container.appendChild(cat_header);

                let prod_list = document.createElement('div');
                prod_list.classList.add('product-list');
            
                // TODO - got to be a better way to iterate through all categories & associate with products for this
                // time complexity on the below would be awful
                for(index = 1; index <= Object.keys(products).length; index++) {

                    product = products[index];
                    
                    if(category.products.includes(index.toString())) {
                        
                        product_elem = document.createElement('div');
                        product_elem.classList.add('product');
                        
                        product_nametag = document.createElement('h3');
                        product_nametag.innerText = product.name;
                        product_elem.appendChild(product_nametag);

                        product_pricetag = document.createElement('p');
                        product_pricetag.dataset['price'] = product.price;
                        product_pricetag.innerText = '£' + (product.price / 100).toFixed(2).toString();
                        product_elem.appendChild(product_pricetag);

                        // TODO - add on click event for product elem (div) to add to ticket
                        product_elem.setAttribute('onclick', `handleProductClick(${product.id})`) 


                        prod_list.appendChild(product_elem);
                    }
                }

                cat_container.appendChild(prod_list);

                document.getElementById('products-container').appendChild(cat_container);       
            } else {
                console.info(`Not displaying category # ${category.id} - no products associated`);
            } 

        }

        async function addProductToOrder(product_id, qty) {
            // TODO - add to a local storage (dont just update the frontend, need to push a new suborder line)

            let table_body = document.getElementById("order-table").children[0];
            let price = products[product_id].price * qty

            let tr = document.createElement('tr');
            tr.dataset.product_id = product_id;
            tr.dataset.qty = qty;
            tr.dataset.price = price;
            // TODO - add suborder line ID to dataset of line also
            
            let qty_col = document.createElement('td');
            qty_col.innerText = `${qty}x`;
            tr.appendChild(qty_col);

            let name_col = document.createElement('td');
            name_col.innerText = products[product_id].name;
            tr.appendChild(name_col);
        
            let price_col = document.createElement('td');
            price_col.innerText = `£${(price / 100).toFixed(2)}`    
            tr.appendChild(price_col);

            // add row to table
            table_body.appendChild(tr);

            // update total value displayed at bottom of order "ticket"
            addToOrderTotal(price);

        }

        // adds given price value to current order total
        async function addToOrderTotal(price) {

            let total_elem = document.getElementById("order-total");
            total_elem.dataset.total = Number(total_elem.dataset.total) + Number(price);
            
            total_elem.innerText = `Total: £${(total_elem.dataset.total / 100).toFixed(2)}`

        }

        async function refreshProductsContainer() {

            await getAllCategories();
            await getAllProducts();

            categories.forEach(cat => {

                if(cat.enabled) {
                    generateCategoryAndProductsEntry(cat, products);
                } else {
                    console.info(`Not displaying category # ${cat.id} - category is disabled`);
                }
                
            });
        }

        async function showSetQtyModal() {
            let overlay = document.getElementsByClassName("modal-overlay")[0];
            let qty_modal = document.getElementById('set-qty-modal');

            overlay.style.display = "flex";
            qty_modal.style.display = "block";
        }

        async function hideSetQtyModal() {
            let overlay = document.getElementsByClassName("modal-overlay")[0];
            let qty_modal = document.getElementById('set-qty-modal');

            overlay.style.display = "none";
            qty_modal.style.display = "none";
        }

        async function addToQty(number) {
            document.getElementById('qty-entry').value += number;
        }

        async function clearQtyEntry() {
            document.getElementById('qty-entry').value = '';
        }

        async function updateQty() {

            let qty_entry = document.getElementById('qty-entry');
            let desired_qty = Number(qty_entry.value);

            // check qty input is greater than 0
            if(desired_qty > 0) {
                qty_modifier_active = true;
                qty_modifier = desired_qty;
            } else {
                // number is less than or equal to 0, cancel operation
                qty_modifier_active = false;
                qty_modifier = 1;
            }

            clearQtyEntry();            
            hideSetQtyModal();


        }

        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(() => {
                refreshProductsContainer();
            }, 5);
        });

    </script>

</html>