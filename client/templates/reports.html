<html>
<head>
  <!-- include master-style.css for global styling -->
  <link href="../frontend/master-style.css" rel="stylesheet"> 
  <!-- include admin.css for button styling -->
  <link href="../frontend/admin.css" rel="stylesheet"> 
  <!-- include reports page specific styling -->
  <link href="../frontend/reports.css" rel="stylesheet"> 
</head>
<body>
  <button class="btn btn-back" onclick="showPage('Nav');">⮨ Back</button>
  <div class="container" style="width: 85%">
    <h1 id="welcome">Reports</h1>
    <p>Browse available reports and get valuable data and insights from your point-of-sale system!</p>
    <div class="spacer" style="margin: 15px 0;"></div>
    <div class="reports-list">
      <div class="report-entry">
        <h2>Today's Earnings</h2>
        <p>This report shows information about your earnings and sales today!</p>
      </div>
      <div class="report-entry">
        <h2>Last 7 days Earnings</h2>
        <p>This report shows information about your earnings and sales over the last 7 days!</p>
      </div>
      <div class="report-entry">
        <h2>Month to Date Earnings</h2>
        <p>This report shows information about your earnings and sales since the start of the month!</p>
      </div>
      <div class="report-entry" onclick="openTablesReport()">
        <h2>Open Tables</h2>
        <p>This report shows information about your currently open tables!</p>
      </div>

    </div>
  </div>
  <div id="modal-overlay">
    <div class="modal report" id="open-tables">
      <h2 id="open-tables-header">You currently have 0 open tables.</h2>
      <div id="open-tables-list">
      </div>
      <button class="btn" onclick="hideModal('open-tables'); document.getElementById('open-tables-list').innerHTML = '';">Close Report</button>
    </div>

    <div class="modal report" id="todays-sales">
      <h2 id="todays-sales-header">Today's Sales: 00/00/0000 | Revenue: £0000.00</h2>
    </div>
    
  </div>
</body>
<script src="../frontend/orders_link.js"></script>
<script src="../frontend/tables_link.js"></script>
<script src="../frontend/window_manager_link.js"></script>
<script src="../frontend/clerks_link.js"></script>

<script async>
  
  async function openTablesReport() {

    let tables = await getAllTablesWithOrderData(true);
    let report_header = document.getElementById('open-tables-header');
    let tables_list = document.getElementById('open-tables-list');

    let open_tables = [];

    tables.forEach(table => {
      // disregard tables with no open orders
      if(table.orders == null) return;
      // extract tables with open orders, store in array
      open_tables.push(table);
    });

    // generate header (with correct gramatical - i.e. plural - use of the word table)
    report_header.innerText = `You currently have ${open_tables.length} open table${open_tables.length == 1 ? "" : "s"}.`

    // check if 1 or more table open
    if(open_tables.length > 0) {

      // create entry for each open table in scrollable list
      open_tables.forEach(async (table) => {
        let order = await getOrderByID(table.orders);
        let clerk = await getClerkByID(order.created_by);
        let created_at = new Date(order.created_at)
        
        let entry = document.createElement('div');
        entry.classList.add("table-entry");
        
        let header = document.createElement('h3');
        header.innerText = table.display_name;
        entry.appendChild(header);

        let subtext = document.createElement('p');
        subtext.innerText = `Opened ${created_at.toLocaleString().replace(",","")} by ${clerk.name}. Current total: £${(order.total / 100).toFixed(2)}`        
        entry.appendChild(subtext);

        // add to list
        tables_list.appendChild(entry);

      });

      console.debug(open_tables)
    }

    showModal("open-tables");

  }

  async function showModal(modal_element_id) {
    let overlay = document.getElementById('modal-overlay');
    let modal = document.getElementById(modal_element_id);

    overlay.style.display = "flex";
    modal.style.display = "block";
  }

  async function hideModal(modal_element_id) {
    let overlay = document.getElementById('modal-overlay');
    let modal = document.getElementById(modal_element_id);

    overlay.style.display = "none";
    modal.style.display = "none";
  }

  async function todaysRevenueReport() {
    let [ revenue, orders ] = await generatetodaysSalesData();
    let today = new Date();

    console.debug(revenue, orders)

    let header = document.getElementById('todays-sales-header');
    header.innerText = `Today's Sales: ${today.toLocaleDateString()} | Revenue: £${(revenue / 100).toFixed(2)}`

    showModal('todays-sales');
  }

  async function generatetodaysSalesData() {
    // order must be closed to be paid
    let orders = await getClosedOrders();
    let todays_date = new Date().setHours(0,0,0,0);

    let todays_orders = [];
    let todays_revenue = 0;

    Object.keys(orders).forEach(index => {

      let order = orders[index];

      // exclude cancelled orders in calc
      if(order.is_cancelled) return;

      let order_date = new Date(order.created_at).setHours(0,0,0,0);

      if(order_date == todays_date) {
        todays_orders.push(order);
        todays_revenue += order.total;
      }

    });

    return [todays_revenue, todays_orders]
  }

  async function getMergedOrders() {
    let open = await getOpenOrders();
    let closed = await getClosedOrders();
    
    let all = [];

    Object.keys(open).forEach(index => {
      all.push(open[index]);
    });

    Object.keys(closed).forEach(index => {
      all.push(closed[index]);
    });

    return all;
    
  }

  
</script>

</html>